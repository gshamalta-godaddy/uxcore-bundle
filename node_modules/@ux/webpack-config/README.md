# @ux/webpack-config

Reusable webpack configuration to use in the `webpack.config.js` of
`@ux/uxcore2` apps.

```
npm install --save @ux/webpack-config
```

Note that we do not install optional dependencies by default, optional
functionality could require additional dependencies to be installed in your
project.

## Motivation

As a developer at GoDaddy **you should [_almost_](#isomorphic-rendering) never
be building `@ux/uxcore2` yourself.** Why is that? Because `@ux/uxcore2` is
provided on the client-side via a CDN. This means that when your application
runs `window.ux.[ComponentName]` already exists (e.g. `window.ux.Button` instead
of `import Button from '@ux/button'`.

All `@ux/uxcore2` applications do need the same shared configuration for their
`webpack.config.js` files. That configuration is exposed through
`@ux/webpack-config`.

### Externalizing `@ux/uxcore2` and building your client JavaScript assets

[WebPack](https://webpack.github.io) config defaults are provided to bridge the
gap between untranspiled code - `require` and `import` statements - and the
[browser structure of UXCore2](#structure), e.g. `window.ux[component]`.

The [defaults] can be used to create your own `webpack.config.js`.
For example, to force WebPack to use externalized React, ReactDOM, and UXCore2
components, use the `uxcore2.externals` defaults. This will ensure that
components like `@ux/dropdown` are not included, but rather referenced as
`window.ux.Dropdown`.

```js
const uxcore2 = require('@ux/webpack-config');
const path = require('path');

module.exports = {
  entry: 'file/to/entry',
  externals: uxcore2.externals,
  output: {
    filename: path.join(__dirname, 'dist', 'bundle.js'),

    /* required when using externals */
    libraryTarget: 'umd'
  }

  /* the rest of your webpack config */
};
```

**Important when using `externals` also make sure to specify a `libraryTarget`,
e.g. `umd` or similar. See [Webpack configuration][library-target] for more
details. Failure to specifiy `libraryTarget` will leave the Webpack bundle
broken. External libraries will be referred to as `undefined`.**

Other available defaults are `require('@ux/webpack-config').module.loaders` with
default JSX loaders and presets. _Note: this config `array` also includes the
SCSS loaders._

> An alias default `require('@ux/webpack-config').alias(__dirname)` is provided
> to refer directly to the bundled distribution file. You'll rarely need this
> to create local vendor bundles; however, it's better to use the prebuild
> version from CDN.

##### Isomorphic rendering

In the less-common case where you need to perform Isomorphic (a.k.a. Universal,
Server-side) rendering, you **WILL** need to build `@ux/uxcore2` yourself. In
this case you should NOT use `require('@ux/webpack-config').externals`.

### Including `@ux/uxcore2` SCSS in client CSS assets

If you also need customized SCSS/CSS builds with only a subset of Bootstrap's
classes or components the [defaults] can be used as well.

```js
const uxcore2 = require('@ux/webpack-config');

module.exports = {
  entry: 'file/to/entry'
  module: uxcore2.module
  //
  // OR
  //
  module: {
    loaders: [ /* already defined loaders */ ].concat(uxcore2.module.loaders)
  }

  /* full webpack config */
};
```

Other available defaults are:

#### sassLoader

This is an optional loader and require additional packages to be installed in
you project:

```
npm install sass-import-modules
```

Use the `require('@ux/webpack-config').sassLoader` to handle module imports from
SCSS.

_Note: `@ux/webpack-config>11` only works with `sass-loader@8`. For any earlier
major versions of `sass-loader` please use `@ux/webpack-config<11`._

#### postcss

This is an optional loader and require additional packages to be installed in
you project:

```
npm install autoprefixer mq4-hover-shim postcss-discard-duplicates
```

Use the `require('@ux/webpack-config').postcss` loader to run our of [PostCSS]
plugins.

#### Palette-aware builds

> **NOTE:** this is the _danger zone._ If you choose to do palette-aware builds
> then **you** are responsible for regularly building them for all palettes.

All UXCore2 builds are designed to work with "palettes" (see: [@ux/palettes]).
These JSON representations are converted to SCSS through `postcss` and `webpack`
via the [`paletteLoader(filename)`], where `filename` is the top-level `scss`
include in your application. e.g.

```js
const uxcore2 = require('@ux/webpack-config');

module.exports = {
  entry: 'file/to/entry'
  module: {
    loaders: uxcore2.module.loaders.concat(
      uxcore2.paletteLoader('index.scss') // Your TOP-LEVEL SCSS include
    )
  }

  /* full webpack config */
};
```

To consume this it is necessary to _parameterize your builds via the `PALETTE`
environment variable._ The above `webpack.config.js` example will **always** be
run with this environment variable for Private Labels and **never** run with it
for GoDaddy's brand:

``` bash
# Private Label
PALETTE=./default-brand.json webpack --config webpack.config.js --progress --bail

# GoDaddy Label
webpack --config webpack.config.js --progress --bail
```

#### Deduping modules

The modular architecture of UXCore2 and the Presentation Central (PC) headers
depends on a lot of different modules. Some modules are used as dependency by
other `@ux` modules multiple times. Although webpack has a dedupe plugin, this
will - by design - not dedupe modules with different resolve paths even if
content is similar. Both UXCore2 and PC headers should always depend on the
latast major version of any `@ux` package. If your depending on a `@ux`
dependency that is not part of predefined [externals] you might benefit from the
same dedupe strategy.

``` js
const config = require('@ux/webpack-config');

module.exports = {
  //
  // This will set `resolve.alias` and `resolve.mainFields`
  //
  resolve: config.resolve({
    rootDir: __dirname
    // Other options:
    // mainFields: ['browser', 'module', 'main']
    // target: 'web'
    // filter: name => { /* return true to dedupe this package */ }
  })

  /* full webpack config */
};
```

Setting the `resolve.alias` field to the predefined modules will ensure
duplicate modules are aliased to the modules resolved from the `package.json` of
the build.

#### Deduping icons

You can remove duplicate `@ux/icon` CSS entries by using the `dedupeIcons`
PostCSS plugin. When an duplicate icon selector is found in your CSS bundle
the properties will be removed so it can be cleaned up fully by a CSS minifier.

This functionality assumes you have `postcss-remove-declaration` installed as
devDependency of your project:

```
npm install postcss-remove-declaration
```

```js
  entry: path.join(__dirname, 'src', 'scss', 'index.scss'),
  output: {
    path: dist
  },
  resolve: config.cssResolve(),
  module: {
    rules: [{
      test: /\.s?css$/,
      use: [
        {
          loader: 'postcss-loader',
          options: {
            plugins: [config.dedupeIcons],
            sourceMap: true
          }
        },
        ...
      ]
    }]
  }
  ...
}]
```

### Removing JS build artifacts

Webpack has no support for CSS only builds; [planned for `webpack@5`...][blogpost]
UXPlatform has multiple builds that only bundle CSS. This plugin allows to
remove the JS output after the webpack compiler is done. Do not specify
`output.filename` and add the plugin to `plugins` in your configuration, example:

```js
const RemoveJSArtifact = require('@ux/webpack-plugin/remove-artifact');

module.exports = [{
  name: 'css',
  entry: path.join(__dirname, 'src', 'scss', 'index.scss'),
  output: {
    path: dist
  },
  plugins: [
    new RemoveJSArtifact(), // will remove `main.js` that is also written to disk.
    new MiniCssExtractPlugin({
      filename: 'yourcssbundlename.css'
    }),
  ],
  ...
}]
```

### Checking included versions

This module also provides a utility read the versions of packages under a given
scope. You can use this via the `read-versions` file:

```js
const path = require('path');
const readVersions = require('@ux/webpack-config/read-versions');

// directory where node_modules exists
const rootDir = path.join(__dirname, '..');

/// desired path of output file
const output = path.resolve(rootDir, 'src', 'versions.static.js');

// desired scopes to investigate
const scopes = ['@any', '@scopes', '@that', '@you', '@want'];

// true if you want to include the host-package's version number
const includeHost = true;

readVersions({ output, scopes, rootDir, includeHost });
```

The desired output will be an ES6 `.js` file that exports an object with the
given versions. For example, [`@gx/canvas`] looks for the scopes `['@ux', '@gx']`
and generates the following file:

```js
/* auto-generated on Wed, 13 Feb 2019 21:45:07 GMT */

export default {
  '@ux/alert': '8.1.2',
  '@ux/button': '15.3.0',
  '@ux/component': '7.1.0',
  '@ux/containers': '2.1.1',
  '@ux/icon': '8.1.0',
  '@ux/inline-styles': '9.5.1',
  '@ux/mdlint': '1.0.5',
  '@ux/message-overlay': '7.1.5',
  '@ux/modal': '9.3.5',
  '@ux/namespace-component': '5.0.1',
  '@ux/react-native-device-fonts': '3.0.1',
  '@ux/spinner': '5.3.1',
  '@ux/webpack-config': '10.0.0',
  '@gx/asset-provider': '4.0.4',
  '@gx/card-catalog-api': '6.0.0',
  '@gx/card-chrome': '5.4.5',
  '@gx/card-template': '2.1.2',
  '@gx/gx-react-intl': '3.0.2',
  '@gx/gx-util': '3.0.3',
  '@gx/intl': '0.1.2',
  '@gx/player': '4.0.2',
  '@gx/react-native-menu': '2.0.2',
  '@gx/canvas': '4.3.0'
};
```

[library-target]: https://webpack.js.org/guides/author-libraries/#add-librarytarget
[externals]: #externalizing-uxuxcore2-and-building-your-client-javascript-assets
[`paletteLoaders(filename)`]: https://github.secureserver.net/uxcore2/ux-webpack-config/blob/run-inject-palette/index.js#L186-L197
[@ux/palettes]: https://github.secureserver.net/uxcore2/ux-palettes
[defaults]: ./index.js
[PostCSS]: https://github.com/postcss/postcss
[`@gx/canvas`]: https://github.secureserver.net/canvas/canvas/blob/master/bin/versions#L8
[blogpost]: https://medium.com/webpack/webpack-4-released-today-6cdb994702d4#d179
