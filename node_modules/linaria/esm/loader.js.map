{"version":3,"sources":["../src/loader.ts"],"names":["path","loaderUtils","enhancedResolve","EvalCache","Module","debug","transform","getCacheInstance","outputCssLoader","require","resolve","loader","content","inputSourceMap","async","resourcePath","clearForFile","sourceMap","undefined","preprocessor","extension","cacheProvider","rest","getOptions","outputFilename","replace","resolveOptions","extensions","resolveSync","create","sync","_compilation","options","alias","modules","result","originalResolveFilename","_resolveFilename","id","filename","dirname","addDependency","relative","process","cwd","pluginOptions","cssText","Buffer","from","cssSourceMapText","toString","dependencies","length","forEach","dep","f","e","console","warn","then","cacheInstance","set","request","encodeURIComponent","stringifiedRequest","stringifyRequest","callback","code","catch","err"],"mappings":"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","sourcesContent":["/**\n * This file contains a Webpack loader for Linaria.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport path from 'path';\nimport loaderUtils from 'loader-utils';\nimport enhancedResolve from 'enhanced-resolve';\nimport type { RawSourceMap } from 'source-map';\nimport * as EvalCache from './babel/eval-cache';\nimport Module from './babel/module';\nimport { debug } from './babel/utils/logger';\nimport transform from './transform';\nimport { getCacheInstance } from './cache';\nimport type { Result } from './types';\n\ntype LoaderContext = Parameters<typeof loaderUtils.getOptions>[0];\n\nconst outputCssLoader = require.resolve('./outputCssLoader');\n\nexport default function loader(\n  this: LoaderContext,\n  content: string,\n  inputSourceMap: RawSourceMap | null\n) {\n  // tell Webpack this loader is async\n  this.async();\n\n  debug('loader', this.resourcePath);\n\n  EvalCache.clearForFile(this.resourcePath);\n\n  const {\n    sourceMap = undefined,\n    preprocessor = undefined,\n    extension = '.linaria.css',\n    cacheProvider,\n    ...rest\n  } = loaderUtils.getOptions(this) || {};\n\n  const outputFilename = this.resourcePath.replace(/\\.[^.]+$/, extension);\n\n  const resolveOptions = {\n    extensions: ['.js', '.jsx', '.ts', '.tsx', '.json'],\n  };\n\n  const resolveSync = enhancedResolve.create.sync(\n    // this._compilation is a deprecated API\n    // However there seems to be no other way to access webpack's resolver\n    // There is this.resolve, but it's asynchronous\n    // Another option is to read the webpack.config.js, but it won't work for programmatic usage\n    // This API is used by many loaders/plugins, so hope we're safe for a while\n    this._compilation?.options.resolve\n      ? {\n          ...resolveOptions,\n          alias: this._compilation.options.resolve.alias,\n          modules: this._compilation.options.resolve.modules,\n        }\n      : resolveOptions\n  );\n\n  let result: Result;\n\n  const originalResolveFilename = Module._resolveFilename;\n\n  try {\n    // Use webpack's resolution when evaluating modules\n    Module._resolveFilename = (id, { filename }) => {\n      const result = resolveSync(path.dirname(filename), id);\n      this.addDependency(result);\n      return result;\n    };\n\n    result = transform(content, {\n      filename: path.relative(process.cwd(), this.resourcePath),\n      inputSourceMap: inputSourceMap ?? undefined,\n      pluginOptions: rest,\n      preprocessor,\n    });\n  } finally {\n    // Restore original behaviour\n    Module._resolveFilename = originalResolveFilename;\n  }\n\n  if (result.cssText) {\n    let { cssText } = result;\n\n    if (sourceMap) {\n      cssText += `/*# sourceMappingURL=data:application/json;base64,${Buffer.from(\n        result.cssSourceMapText || ''\n      ).toString('base64')}*/`;\n    }\n\n    if (result.dependencies?.length) {\n      result.dependencies.forEach((dep) => {\n        try {\n          const f = resolveSync(path.dirname(this.resourcePath), dep);\n\n          this.addDependency(f);\n        } catch (e) {\n          // eslint-disable-next-line no-console\n          console.warn(`[linaria] failed to add dependency for: ${dep}`, e);\n        }\n      });\n    }\n\n    getCacheInstance(cacheProvider)\n      .then((cacheInstance) => cacheInstance.set(this.resourcePath, cssText))\n      .then(() => {\n        const request = `${outputFilename}!=!${outputCssLoader}?cacheProvider=${encodeURIComponent(\n          cacheProvider ?? ''\n        )}!${this.resourcePath}`;\n        const stringifiedRequest = loaderUtils.stringifyRequest(this, request);\n\n        return this.callback(\n          null,\n          `${result.code}\\n\\nrequire(${stringifiedRequest});`,\n          result.sourceMap ?? undefined\n        );\n      })\n      .catch((err: Error) => this.callback(err));\n    return;\n  }\n\n  this.callback(null, result.code, result.sourceMap ?? undefined);\n}\n"],"file":"loader.js"}